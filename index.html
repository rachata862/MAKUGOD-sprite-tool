<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sprite Tool (Grid Cutter + Preview + Export)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 16px; background: #0b0f14; color: #e6edf3; }
    h1 { margin: 0 0 8px; font-size: 18px; }
    .wrap { display: grid; grid-template-columns: 360px 1fr; gap: 12px; }
    .card { background: #111824; border: 1px solid #233044; border-radius: 14px; padding: 12px; }
    label { display: block; font-size: 12px; opacity: .9; margin: 10px 0 6px; }
    input[type="number"], input[type="text"], select {
      width: 100%; box-sizing: border-box;
      background: #0b1220; color: #e6edf3;
      border: 1px solid #233044; border-radius: 10px;
      padding: 10px;
    }
    input[type="range"] { width: 100%; }
    button {
      width: 100%; padding: 10px; margin-top: 10px;
      background: #1f6feb; color: white; border: 0;
      border-radius: 10px; cursor: pointer;
      font-weight: 600;
    }
    button.secondary { background: #2d384a; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .small { font-size: 12px; opacity: .85; line-height: 1.4; }
    canvas { width: 100%; background: #0b1220; border: 1px solid #233044; border-radius: 14px; }
    .pill { display:inline-block; padding: 2px 8px; border: 1px solid #233044; border-radius: 999px; font-size: 12px; opacity: .9; }
    .hr { height: 1px; background: #233044; margin: 12px 0; }
  </style>
</head>
<body>
  <h1>Sprite Tool — Grid Cutter + Preview + Export</h1>
  <div class="small">
    ทำงานในเบราว์เซอร์ (local) • ไม่อัปโหลดรูปออก • เหมาะกับเครื่องที่ติดข้อจำกัด
  </div>

  <div class="wrap" style="margin-top:12px;">
    <div class="card">
      <label>1) ใส่รูป (PNG แนะนำ)</label>
      <input id="file" type="file" accept="image/*" />

      <div class="hr"></div>

      <label>2) โหมดการตัด</label>
      <select id="mode">
        <option value="colsrows">กำหนด Columns + Rows</option>
        <option value="framesize">กำหนด Frame Width + Height</option>
      </select>

      <div id="colsrowsBox">
        <div class="row">
          <div>
            <label>Columns</label>
            <input id="cols" type="number" min="1" value="4" />
          </div>
          <div>
            <label>Rows</label>
            <input id="rows" type="number" min="1" value="1" />
          </div>
        </div>
      </div>

      <div id="framesizeBox" style="display:none;">
        <div class="row">
          <div>
            <label>Frame Width (px)</label>
            <input id="fw" type="number" min="1" value="64" />
          </div>
          <div>
            <label>Frame Height (px)</label>
            <input id="fh" type="number" min="1" value="64" />
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Margin (px)</label>
          <input id="margin" type="number" min="0" value="0" />
        </div>
        <div>
          <label>Spacing (px)</label>
          <input id="spacing" type="number" min="0" value="0" />
        </div>
      </div>

      <label>3) Pivot (สำหรับกัน “ตัวละครเด้ง”) — ค่าเป็นสัดส่วน 0..1</label>
      <div class="row">
        <div>
          <label>Pivot X</label>
          <input id="px" type="number" step="0.01" min="0" max="1" value="0.5" />
        </div>
        <div>
          <label>Pivot Y</label>
          <input id="py" type="number" step="0.01" min="0" max="1" value="1.0" />
        </div>
      </div>

      <div class="hr"></div>

      <label>4) Preview</label>
      <div class="row">
        <div>
          <label>FPS: <span class="pill" id="fpsVal">8</span></label>
          <input id="fps" type="range" min="1" max="24" value="8" />
        </div>
        <div>
          <label>Frame Index: <span class="pill" id="idxVal">0</span></label>
          <input id="frameIdx" type="range" min="0" max="0" value="0" />
        </div>
      </div>

      <button id="btnPlay" class="secondary" disabled>▶ Play / Pause</button>

      <div class="hr"></div>

      <label>5) Export</label>
      <input id="state" type="text" value="walk" placeholder="state name เช่น idle/walk/run/sleep/dead" />
      <button id="btnJSON" disabled>Export JSON metadata</button>
      <button id="btnZIP" disabled>Download frames (ZIP)</button>

      <div class="small" style="margin-top:10px; opacity:.8">
        หมายเหตุ: ZIP จะถูกสร้างในเบราว์เซอร์ อาจช้าถ้าเฟรมเยอะมาก
      </div>
    </div>

    <div class="card">
      <div class="row" style="align-items:center;">
        <div class="small">
          <b>Preview Canvas</b><br/>
          แสดงกริด + pivot (จุดสีแดง) + bounding ของเฟรมที่เลือก
        </div>
        <div style="text-align:right;">
          <span class="pill" id="imgInfo">No image</span>
        </div>
      </div>
      <div style="margin-top:10px;">
        <canvas id="cv" width="960" height="540"></canvas>
      </div>
    </div>
  </div>

<script>
// --- Minimal JSZip (loaded from CDN) ---
const jszipScript = document.createElement('script');
jszipScript.src = "https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js";
jszipScript.onload = () => window.__zipReady = true;
document.head.appendChild(jszipScript);

const el = (id) => document.getElementById(id);
const fileEl = el('file');
const modeEl = el('mode');
const colsEl = el('cols');
const rowsEl = el('rows');
const fwEl = el('fw');
const fhEl = el('fh');
const marginEl = el('margin');
const spacingEl = el('spacing');
const pxEl = el('px');
const pyEl = el('py');
const fpsEl = el('fps');
const fpsVal = el('fpsVal');
const frameIdxEl = el('frameIdx');
const idxVal = el('idxVal');
const btnPlay = el('btnPlay');
const btnJSON = el('btnJSON');
const btnZIP = el('btnZIP');
const stateEl = el('state');
const imgInfo = el('imgInfo');

const colsrowsBox = el('colsrowsBox');
const framesizeBox = el('framesizeBox');

const cv = el('cv');
const ctx = cv.getContext('2d');

let img = null;
let frames = []; // {x,y,w,h}
let playing = false;
let timer = null;

function setModeUI() {
  const m = modeEl.value;
  colsrowsBox.style.display = m === 'colsrows' ? '' : 'none';
  framesizeBox.style.display = m === 'framesize' ? '' : 'none';
  recompute();
}

modeEl.addEventListener('change', setModeUI);

function loadImage(file) {
  return new Promise((resolve, reject) => {
    const url = URL.createObjectURL(file);
    const i = new Image();
    i.onload = () => { URL.revokeObjectURL(url); resolve(i); };
    i.onerror = reject;
    i.src = url;
  });
}

fileEl.addEventListener('change', async () => {
  const f = fileEl.files?.[0];
  if (!f) return;
  img = await loadImage(f);
  imgInfo.textContent = `${img.width}x${img.height}px`;
  recompute();
  btnPlay.disabled = false;
  btnJSON.disabled = false;
  btnZIP.disabled = false;
});

function clampInt(v, min, max) {
  v = Math.floor(Number(v));
  if (Number.isNaN(v)) return min;
  return Math.max(min, Math.min(max, v));
}

function recompute() {
  if (!img) { draw(); return; }
  const margin = clampInt(marginEl.value, 0, 9999);
  const spacing = clampInt(spacingEl.value, 0, 9999);

  frames = [];
  if (modeEl.value === 'colsrows') {
    const cols = clampInt(colsEl.value, 1, 9999);
    const rows = clampInt(rowsEl.value, 1, 9999);
    const w = Math.floor((img.width - 2*margin - (cols-1)*spacing) / cols);
    const h = Math.floor((img.height - 2*margin - (rows-1)*spacing) / rows);

    for (let r=0; r<rows; r++) {
      for (let c=0; c<cols; c++) {
        const x = margin + c*(w+spacing);
        const y = margin + r*(h+spacing);
        frames.push({x,y,w,h});
      }
    }
  } else {
    const fw = clampInt(fwEl.value, 1, img.width);
    const fh = clampInt(fhEl.value, 1, img.height);
    const cols = Math.floor((img.width - 2*margin + spacing) / (fw + spacing));
    const rows = Math.floor((img.height - 2*margin + spacing) / (fh + spacing));

    for (let r=0; r<rows; r++) {
      for (let c=0; c<cols; c++) {
        const x = margin + c*(fw+spacing);
        const y = margin + r*(fh+spacing);
        if (x+fw <= img.width - margin + 1 && y+fh <= img.height - margin + 1) {
          frames.push({x,y,w:fw,h:fh});
        }
      }
    }
  }

  frameIdxEl.max = String(Math.max(0, frames.length - 1));
  frameIdxEl.value = String(Math.min(Number(frameIdxEl.value), Number(frameIdxEl.max)));
  idxVal.textContent = frameIdxEl.value;

  draw();
}

[colsEl, rowsEl, fwEl, fhEl, marginEl, spacingEl, pxEl, pyEl].forEach(e => e.addEventListener('input', recompute));

fpsEl.addEventListener('input', () => {
  fpsVal.textContent = fpsEl.value;
  if (playing) startTimer();
});

frameIdxEl.addEventListener('input', () => {
  idxVal.textContent = frameIdxEl.value;
  draw();
});

function draw() {
  // clear
  ctx.clearRect(0,0,cv.width,cv.height);
  // background grid
  ctx.fillStyle = '#0b1220';
  ctx.fillRect(0,0,cv.width,cv.height);

  if (!img) {
    ctx.fillStyle = '#e6edf3';
    ctx.font = '16px system-ui';
    ctx.fillText('อัปโหลดรูปเพื่อเริ่ม', 20, 40);
    return;
  }

  // Fit image to canvas
  const scale = Math.min(cv.width / img.width, cv.height / img.height);
  const ox = (cv.width - img.width*scale)/2;
  const oy = (cv.height - img.height*scale)/2;

  ctx.imageSmoothingEnabled = false;
  ctx.drawImage(img, ox, oy, img.width*scale, img.height*scale);

  // draw frame rects
  ctx.strokeStyle = 'rgba(180, 200, 255, 0.35)';
  ctx.lineWidth = 1;
  for (const fr of frames) {
    ctx.strokeRect(ox + fr.x*scale, oy + fr.y*scale, fr.w*scale, fr.h*scale);
  }

  const idx = clampInt(frameIdxEl.value, 0, Math.max(0, frames.length-1));
  const fr = frames[idx];
  if (fr) {
    // highlight selected frame
    ctx.strokeStyle = 'rgba(31, 111, 235, 0.95)';
    ctx.lineWidth = 2;
    ctx.strokeRect(ox + fr.x*scale, oy + fr.y*scale, fr.w*scale, fr.h*scale);

    // pivot
    const px = Number(pxEl.value);
    const py = Number(pyEl.value);
    const pivotX = fr.x + fr.w * (Number.isFinite(px) ? px : 0.5);
    const pivotY = fr.y + fr.h * (Number.isFinite(py) ? py : 1.0);

    ctx.fillStyle = 'rgba(255, 80, 80, 0.95)';
    ctx.beginPath();
    ctx.arc(ox + pivotX*scale, oy + pivotY*scale, 4, 0, Math.PI*2);
    ctx.fill();
  }

  // preview thumbnail (selected frame) at bottom-left
  if (fr) {
    const pad = 10;
    const thW = 220;
    const thH = 220;
    const x = pad, y = cv.height - thH - pad;

    ctx.fillStyle = 'rgba(0,0,0,0.35)';
    ctx.fillRect(x, y, thW, thH);

    // fit frame in thumbnail box
    const s = Math.min((thW-20)/fr.w, (thH-20)/fr.h);
    const dx = x + (thW - fr.w*s)/2;
    const dy = y + (thH - fr.h*s)/2;

    ctx.imageSmoothingEnabled = false;
    ctx.drawImage(img, fr.x, fr.y, fr.w, fr.h, dx, dy, fr.w*s, fr.h*s);
  }
}

function startTimer() {
  if (timer) clearInterval(timer);
  const fps = clampInt(fpsEl.value, 1, 60);
  timer = setInterval(() => {
    const max = Number(frameIdxEl.max);
    let v = Number(frameIdxEl.value);
    v = (v + 1) > max ? 0 : (v + 1);
    frameIdxEl.value = String(v);
    idxVal.textContent = frameIdxEl.value;
    draw();
  }, Math.floor(1000 / fps));
}

btnPlay.addEventListener('click', () => {
  playing = !playing;
  btnPlay.textContent = playing ? '⏸ Pause' : '▶ Play / Pause';
  if (playing) startTimer();
  else { if (timer) clearInterval(timer); timer = null; }
});

function downloadBlob(blob, filename) {
  const a = document.createElement('a');
  const url = URL.createObjectURL(blob);
  a.href = url;
  a.download = filename;
  a.click();
  setTimeout(() => URL.revokeObjectURL(url), 2000);
}

btnJSON.addEventListener('click', () => {
  if (!img || frames.length === 0) return;
  const state = (stateEl.value || 'state').trim();
  const px = Number(pxEl.value);
  const py = Number(pyEl.value);

  const data = {
    state,
    image: { width: img.width, height: img.height },
    pivot: {
      x: Number.isFinite(px) ? px : 0.5,
      y: Number.isFinite(py) ? py : 1.0
    },
    frames: frames.map((fr, i) => ({
      index: i,
      x: fr.x, y: fr.y, w: fr.w, h: fr.h,
      duration_ms: Math.floor(1000 / clampInt(fpsEl.value, 1, 60))
    }))
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  downloadBlob(blob, `${state}.json`);
});

btnZIP.addEventListener('click', async () => {
  if (!img || frames.length === 0) return;
  if (!window.JSZip) {
    alert('JSZip ยังโหลดไม่เสร็จ ลองใหม่อีกครั้ง');
    return;
  }
  const state = (stateEl.value || 'state').trim();
  const zip = new JSZip();

  const off = document.createElement('canvas');
  const octx = off.getContext('2d');
  octx.imageSmoothingEnabled = false;

  for (let i=0; i<frames.length; i++) {
    const fr = frames[i];
    off.width = fr.w; off.height = fr.h;
    octx.clearRect(0,0,fr.w,fr.h);
    octx.drawImage(img, fr.x, fr.y, fr.w, fr.h, 0, 0, fr.w, fr.h);

    const blob = await new Promise(res => off.toBlob(res, 'image/png'));
    const arr = await blob.arrayBuffer();
    zip.file(`${state}_${String(i).padStart(3,'0')}.png`, arr);
  }

  // also include JSON
  const px = Number(pxEl.value);
  const py = Number(pyEl.value);
  const meta = {
    state,
    image: { width: img.width, height: img.height },
    pivot: { x: Number.isFinite(px) ? px : 0.5, y: Number.isFinite(py) ? py : 1.0 },
    frames: frames.map((fr, i) => ({ index:i, x:fr.x, y:fr.y, w:fr.w, h:fr.h }))
  };
  zip.file(`${state}.json`, JSON.stringify(meta, null, 2));

  const out = await zip.generateAsync({type:'blob'});
  downloadBlob(out, `${state}_frames.zip`);
});

// init
setModeUI();
fpsVal.textContent = fpsEl.value;
</script>
</body>
</html>
